<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Smith charts and their interpretation - EA1HET</title><meta name="description" content="Intro Ham radio hobbyists, as the former term indicate, have been all&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://ea1het.com/smith-charts-and-their-interpretation.html"><link rel="alternate" type="application/atom+xml" href="https://ea1het.com/feed.xml"><link rel="alternate" type="application/json" href="https://ea1het.com/feed.json"><meta property="og:title" content="Smith charts and their interpretation"><meta property="og:site_name" content="EA1HET"><meta property="og:description" content="Intro Ham radio hobbyists, as the former term indicate, have been all&hellip;"><meta property="og:url" content="https://ea1het.com/smith-charts-and-their-interpretation.html"><meta property="og:type" content="article"><link rel="stylesheet" href="https://ea1het.com/assets/css/style.css?v=d3acd2c08fe6f53e6ff9e9111d8c2740"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://ea1het.com/smith-charts-and-their-interpretation.html"},"headline":"Smith charts and their interpretation","datePublished":"2024-09-22T15:56","dateModified":"2024-09-22T15:56","description":"Intro Ham radio hobbyists, as the former term indicate, have been all&hellip;","author":{"@type":"Person","name":"Jonathan Gonzalez","url":"https://ea1het.com/authors/jonathan-gonzalez/"},"publisher":{"@type":"Organization","name":"Jonathan Gonzalez"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><div class="container"><header class="top" id="js-top"><div><a class="logo" href="https://ea1het.com/">EA1HET</a><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false" height="15px" width="15px"><use xlink:href="https://ea1het.com/assets/svg/svg-map.svg#search"/></svg></button></div></div></header><main class="post"><article class="content wrapper"><div class="hero hero--full"><header class="hero__header"><h1>Smith charts and their interpretation</h1><address>by <a href="https://ea1het.com/authors/jonathan-gonzalez/" rel="author">Jonathan Gonzalez</a></address>published on <time datetime="2024-09-22T15:56">September 22, 2024</time></header></div><div class="content__entry"><h1>Intro</h1><p>Ham radio hobbyists, as the former term indicate, have been all over the time great technicians, but with exceptions, never professionals on electrical or electronics works and related fields.</p><p>There are aspects of the radio where the hobbyists rub the professional turf. One of this aspects is antenna design. Until present, the biggest difference between a professional and a hobbyist was the amount of technology available to them, especially measurement equipment. General knowledge was already at hand, as books and encyclopaedias were available to both.</p><p>More in depth on antenna design, both professionals and hobbyist manage similar concepts, like SWR (stationary wave relationship), capacitance or inductance of circuits.</p><p>Nowadays, it’s easy to see a professional using expensive equipment, mostly software based, performing complex calculations, but, there was a point in time where those calculations were done manually using simple tools like a Smith Chart.</p><h1>A bit of history</h1><p>Smith charts were originally developed around 1940 by Phillip Smith as a useful tool for making the equations involved in transmission lines easier to manipulate. With modern computers and the use of software, the Smith chart is no longer used for the calculation of transmission line equations, however, their value in visualising the impedance of an antenna, or a transmission line, has not decreased.</p><p>The Smith chart is a graphical calculator, or nomogram, designed for electrical and electronics engineers specialising in radio frequency (RF) engineering to assist in solving problems with transmission lines and matching circuits. The use of the Smith chart, and the interpretation of the results obtained using it, requires a good understanding of AC circuit theory and transmission-line theory, both of which are prerequisites for RF engineers and, why not, for general radio hobbyists.</p><p>The Smith chart is a fantastic tool for visualising the impedance of a transmission line and antenna system as a function of frequency. Smith charts can be used to increase understanding of transmission lines and how they behave from an impedance viewpoint. Smith charts are also extremely helpful for impedance matching. The Smith chart is used to display an actual (physical) antenna's impedance when measured on a Vector Network Analyser (VNA).</p><h1>Network Analysers</h1><p>In general, a network analyser is an instrument that measures the parameters of electrical networks. Analysers could be of two main types, Scalar Network Analyser (SNA), that measures amplitude properties only, and Vector Network Analyser (VNA), that measures both amplitude and phase properties.</p><p>A Vector Network Analyser (VNA) is a form of RF network analyser widely used for RF design applications. A VNA may also be called a gain–phase meter or an automatic network analyser. An SNA is functionally identical to a spectrum analyser in combination with a tracking generator.</p><p>Nowadays, VNAs are the most common type of network analysers, and so references to an unqualified "network analyser" most often mean a VNA.</p><p>With the advent of software and the cost reduction on materials crafted on China, entry-level devices and do-it-yourself projects have also been available, some for less than $100, mainly from the amateur radio sector. Although these have significantly reduced features compared to professional devices and offer only a limited range of functions, they are often sufficient for private users, especially during studies and for hobby applications up to the single-digit GHz range.</p><h1>S-Parameters (scattering parameters)</h1><p>Scattering parameters, or S-parameters, are popular in RF/Microwave circuit design and testing. Following are scattering parameters used for measuring/characterising an RF device.</p><p>From the Figure 1, beside, following two equations are derived:</p><p>b1 = S11 x a1 + S12 x a2 b2 = S21 x a1 + S22 x a2</p><p>S11 → Reflection coefficient at Port1 S22 → Reflection coefficient at Port2 S12 → Isolation (Reverse) S21 → Insertion loss (passive device case)</p><p><img loading="lazy" src="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7ab2b3cd-511a-4062-b3b9-45281fb659b2/Untitled.png" alt="Figure 1: S-Parameters " data-is-external-image="true"></p><p>Figure 1: S-Parameters</p><p>S-parameters are vector entities which are derived from vector based measurements like magnitude or phase. Following scalar measurements are derived from S-parameters:</p><ul><li>Reflection and incident waves (S-parameters S11 &amp; S22):<ul><li>Input SWR</li><li>Return Loss</li><li>VSWR</li><li>Input / output impedance</li><li>Reflection coefficient</li></ul></li><li>Transmission and incident waves (S-parameters S21 &amp; S12):<ul><li>Gain / Insertion Loss</li><li>Isolation</li><li>Insertion phase</li><li>Group delay</li><li>Transmission coefficient</li></ul></li></ul><p>As you can see, S-parameters describe the input-output relationship between ports (or terminals) in an electrical system. For example, if we have 2 ports (intelligently called Port 1 and Port 2), then:</p><ul><li>S12 represents the power transferred from Port 2 to Port 1.</li><li>S21 represents the power transferred from Port 1 to Port 2.</li></ul><p>In general, S<em>nm</em> represents the power transferred from Port <em>m</em> to Port <em>n</em> in a multi-port network. These S-parameters are defined in terms of incident and reflected travelling waves.</p><p>As it was argued above, a port can be loosely defined as any place where we can deliver voltage and current. So, if we have a communication system with two radios (radio 1 and radio 2), then the radio terminals (which deliver power to the two antennas) would be the two ports:</p><ul><li>S11 then would be the reflected power radio 1 is trying to deliver to antenna 1.</li><li>S22 would be the reflected power radio 2 is attempting to deliver to antenna 2.</li><li>And S12 is the power from radio 2 that is delivered through antenna 1 to radio 1.</li></ul><p><strong>Note that, while operating with RF equipment, in general S-parameters are a function of frequency,</strong> i.e. vary with frequency. In these scenarios S-parameters are simple to use in analysis. As they are very easy to measure using network analysers, the popularity of the use of such parameters have been increased.</p><p>While working on RF with an analyser will see very often repeated some specific S-parameters which include:</p><ul><li>S11 / S22 —&gt; reflection coefficient</li><li>S12 —&gt; Isolation</li><li>S21 —&gt; Insertion loss</li></ul><figure class="post__image"><img loading="lazy" src="https://ea1het.com/media/posts/3/Screenshot-2024-09-22-at-15.55.27.png" alt="" width="543" height="408" sizes="(max-width: 1024px) 100vw, 1024px" srcset="https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.55.27-xs.png 300w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.55.27-sm.png 480w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.55.27-md.png 768w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.55.27-lg.png 1024w"></figure><p> </p><p>In practice, the most commonly quoted parameter in regards to antennas is S11. S11 represents how much power is reflected from the antenna, and hence is known as the <strong>reflection coefficient,</strong> sometimes written as <em>gamma</em> or <strong>return loss</strong>.</p><ul><li>If S11 = 0 dB, then all the power is reflected from the antenna and nothing is radiated.</li><li>If S11 = -10 dB, this implies that if 3 dB of power is delivered to the antenna, -7 dB is the reflected power.</li></ul><p>The remainder of the power was "accepted by" or delivered to the antenna. This accepted power is either radiated or absorbed as losses within the antenna. Since antennas are typically designed to be low loss, ideally the majority of the power delivered to the antenna is radiated. The concept of <a href="http://www.antenna-theory.com/definitions/vswr.php">VSWR</a> is directly related to S11.</p><h1>VNAs and the S-parameters</h1><p>A VNA is a test system that enables the RF performance of radio frequency and microwave devices to be characterised in terms of network <a href="https://en.wikipedia.org/wiki/Scattering_parameters">scattering parameters</a>, or S-parameters.</p><p>The diagram shows the essential parts of a typical 2-port vector network analyzer (VNA). The two ports of the <a href="https://en.wikipedia.org/wiki/Device_under_test">device under test</a> (DUT) are denoted port 1 (P1) and port 2 (P2). The test port connectors provided on the VNA itself are precision types which will normally have to be extended and connected to P1 and P2 using precision cables 1 and 2, PC1 and PC2 respectively and suitable connector adaptors A1 and A2 respectively.</p><p>Following the diagram on Figure 1, the test frequency is generated by a variable frequency <a href="https://en.wikipedia.org/wiki/Carrier_wave">CW</a> source and its power level is set using a variable <a href="https://en.wikipedia.org/wiki/Attenuator_(electronics)">attenuator</a>. The position of switch SW1 sets the direction that the test signal passes through the DUT. Initially consider that SW1 is at position 1 so that the test signal is incident on the DUT at P1 which is appropriate for measuring S11 and S21. The test signal is fed by SW1 to the common port of splitter 1, one arm (the reference channel) feeding a reference receiver for P1 (RX REF1) and the other (the test channel) connecting to P1 via the <a href="https://en.wikipedia.org/wiki/Directional_coupler">directional coupler</a> DC1, PC1 and A1. The third port of DC1 couples off the power reflected from P1 via A1 and PC1, then feeding it to test receiver 1 (RX TEST1). Similarly, signals leaving P2 pass via A2, PC2 and DC2 to RX TEST2. RX REF1, RX TEST1, RX REF2 and RXTEST2 are known as <a href="https://en.wikipedia.org/wiki/Coherence_(physics)">coherent</a> receivers as they share the same reference oscillator, and they are capable of measuring the test signal's amplitude <em>and</em> phase at the test frequency.</p><figure class="post__image"><img loading="lazy" src="https://ea1het.com/media/posts/3/Screenshot-2024-09-22-at-15.56.04.png" alt="" width="704" height="487" sizes="(max-width: 1024px) 100vw, 1024px" srcset="https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.56.04-xs.png 300w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.56.04-sm.png 480w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.56.04-md.png 768w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.56.04-lg.png 1024w"></figure><p>Figure 1: The basic parts of a vector network analyser.</p><p>All of the complex receiver output signals are fed to a processor which does the mathematical processing and displays the chosen parameters and format on the phase and amplitude display.</p><p>The <a href="https://en.wikipedia.org/wiki/Instantaneous">instantaneous</a> value of phase includes both the <a href="https://en.wikipedia.org/wiki/Time">temporal</a> and <a href="https://en.wikipedia.org/wiki/Three-dimensional_space">spatial</a> parts, but the former is removed by virtue of using 2 test channels, one as a reference and the other for measurement.</p><p>When SW1 is set to position 2, the test signals are applied to P2, the reference is measured by RX REF2, reflections from P2 are coupled off by DC2 and measured by RX TEST2 and signals leaving P1 are coupled off by DC1 and measured by RX TEST1. This position is appropriate for measuring S22 and S12.</p><h1>NanoVNA</h1><p>TBD</p><figure class="post__image"><img loading="lazy" src="https://ea1het.com/media/posts/3/Screenshot-2024-09-22-at-15.56.28.png" alt="" width="708" height="532" sizes="(max-width: 1024px) 100vw, 1024px" srcset="https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.56.28-xs.png 300w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.56.28-sm.png 480w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.56.28-md.png 768w, https://ea1het.com/media/posts/3/responsive/Screenshot-2024-09-22-at-15.56.28-lg.png 1024w"></figure><p>Figure 2: Smith chart representation from a NanoVNA device featuring S-parameters on two traces, trace 1 in SWR representation format, and trace 3 for Smith chart representation on R + LC representation</p><p>TBD</p><p></p></div><aside><p class="content__last-updated">This article was updated on September 22, 2024</p><div class="content__share"></div></aside><footer><div class="content__bio"><h3><a href="https://ea1het.com/authors/jonathan-gonzalez/" class="inverse" title="Jonathan Gonzalez">Jonathan Gonzalez</a></h3></div><nav class="content__nav"><div class="content__nav__next">Next Post<h3 class="h5"><a href="https://ea1het.com/tuning-on-the-jpc-12.html" class="inverse" rel="next">Tuning on the JPC-12</a></h3></div></nav></footer></article></main></div><footer class="footer"><div class="footer__wrapper"><div class="footer__copyright"><p>Powered by Publii</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://ea1het.com/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://ea1het.com/assets/js/scripts.min.js?v=e2bc0e7d7ff60ea78ee920470cf8c8a1"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience, serve personalized ads or content, and analyze our traffic. By clicking "Accept All", you consent to our use of cookies.</div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Required</summary></details><div class="pcb__popup__switch is-checked"><input type="checkbox" data-group-name="" id="pcb-group-0" checked="checked"> <label for="pcb-group-0">Required</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject all</button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>